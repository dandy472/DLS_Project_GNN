# Исследование # 
## 1.	Знакомство с геометрическим Machine Learning (GML) ## 
В рамках финального проекта 1 семестра DLS выбрано направление Геометрического ML, основная цель которого – ознакомиться с основными идеями геометрического ML и топологического анализа данных с последующим практическим применением.   
В ходе изучения GML, в том числе и на основе [статей Maurice Weiler](https://maurice-weiler.gitlab.io/blog_post/cnn-book_1_equivariant_networks), установлено, что для создания эффективных моделей необходимо включить в их архитектуру знание о группах симметрий, действующих на входных данных.  В зависимости от задачи, модель должна демонстрировать либо *инвариантность* (результат модели не должен меняться, когда входные данные преобразуются симметрией (например, энергия молекулы не зависит от ее ориентации в пространстве)), либо *эквивариантность* (модель согласована с симметрией: преобразование результата строго соответствует преобразованию ввода (например, если молекулу повернуть, предсказанные для нее векторы сил повернутся точно так же)).  
Группы симметрий различаются по типам преобразований. Например **E(3)** (евклидовы движения: вращения, отражения, переводы), **SE(3)** (только вращения и переводы), **SU(3)** («специальная» подгруппа группы  унитарных преобразований комплексного 3D-пространства, сохраняющая скалярное произведение в комплексном пространстве, с определителем, равным +1) или **SO(3)** («специальная» подгруппа группы всех ортогональных преобразований 3D-пространства, которая включает только вращения). Эти принципы универсальны и применимы к другим структурам данных. В частности, графы как объекты обладают симметрией относительно перестановки (или перенумерации) своих вершин, описываемой симметрической группой **Sn**. Поэтому модели, работающие с графами, по своей природе должны быть перестановочно-эквивариантными (или инвариантными).  
**Графовые нейронные сети (GNN)** являются одним из инструментом GML, который в своей базовой архитектуре гарантирует выполнение этого свойства. Они обеспечивают эквивариантность на уровне вершин (например, для задач классификации узлов) и инвариантность на уровне всего графа (для задач классификации графов).  
По согласованию с куратором проекта, дальнейшая работа по GML построена на исследовании социальных сетей с использованием GNN.   

## 2.	Выбор датасета с симметриями ##
Для исследования выбран датасет [Facebook](https://snap.stanford.edu/data/ego-Facebook.html), содержащем 4039 узлов и 88234 рёбер.  Его ключевые особенности:  
•	Скрытые фичи узлов (позволяют измерять сходство между пользователями);  
•	Ручная разметка социальных кругов (circles) самими пользователями (хоть и субъективна, но будет использована как ground truth для валидации);  
•	Реальная структура социального графа (согласно описанию датасета, коэффициент кластеризации составляет 0.605).  

**Геометрические prior'ы датасета:**  
Датасет обладает prior'ами, характерными для социальных сетей:  
1.	Гомофилия: корреляция между геометрической близостью узлов (пользователей) в пространстве фичей и наличия связи (ребра) между ними. 
2.	Транзитивность: высокая вероятность образования связи между узлами, имеющими общего соседа.  
3.	Ассортативность по степени: узлы со схожей степенью с большей вероятностью связаны между собой. 

**Симметрии:**  
При представлении данных в виде графа возникают требования к симметрии модели:
1.	Перестановочная эквивариантность: модель должна преобразовать эмбеддинги узлов соответствующим образом при их переиндексации.
2.	Инвариантность выхода (для графа в целом): при решении задачи классификации всего графа (например, предсказание типа подсети (ego-network)) результат модели должен быть инвариантен к любой перестановке узлов.


## 3.	Собрать pipeline с топологическим анализом данных (TDA) ##
    
### 3.1 Установка эксперимента  ###
Для изучения геометрической структуры графа был проведён двухуровневый TDA, основанный на построении комплекса Виеториса-Рипса (VR-комплекса).
 - **Локальный анализ: Ego-networks**  
Анализ проводился на 10 ego-networks с целью проверки геометрических prior'ов, характерных для социальных сетей.
Ввиду ограниченного диаметра ego-networks (≤2), стандартная метрика кратчайшего пути не выявила топологической структуры. Была применена альтернативная метрика - расстояние Жаккара (Jaccard), учитывающая сходство окружения (общих друзей) для узла. Расстояние между узлами *u* и *v* рассчитывалось как:  
$$jaccard(u, v) = 1 - \frac{|neighbors(u) ∩ neighbors(v)|} {|neighbors(u) ∪ neighbors(v)|}$$

- **Глобальный анализ: Полный граф**  
Для изучения структурных инвариантов на уровне всей социальной системы был проведён TDA на репрезентативной выборке из 1500 узлов (~37% от всего графа, поскольку имеется ограничение по памяти), отобранных случайным образом для сохранения структурных характеристик.  
Для каждого уровня анализа извлекались:  
•	Персистентные диаграммы для размерностей 0 и 1 (H0 — компоненты связности, H1 — циклы);  
•	Время жизни персистентных классов;  
•	Топологические инварианты: числа Бетти, полная персистентность, энтропия персистентности;  
•	Глобальные структурные признаки: ассортативность, коэффициент кластеризации, центральности.
  
### 3.2. Реализация  ###
Представлена в ноутбуке 2. TDA.ipynb

### 3.3. Результаты ###  
#### Локальная структура (структурный и семантический TDA) ####
|Prior|Гипотеза|Метрика|Результат|Вывод|
|:-|:-:|--|--|--|
|**Гомофилия**|Узлы внутри одного пользовательского круга семантически/структурно похожи.|Силуэтный коэффициент кластеризации по кругам в пространстве эмбеддингов/расстояний Жаккара.| не превысил -0.02|**Не подтверждено** для размеченных пользователями кругов. Круги субъективны и не соответствуют кластерам в данных.|
|**Транзитивность**|Граф содержит множество "социальных треугольников".|Коэффициент кластеризации + наличие циклов H1 в персистентной диаграмме.|H1 есть, но время жизни невелико. Коэффициент кластеризации около 0.6|**Частично подтверждено**. Структурные циклы существуют, но нестабильны.|
|**Ассортативность по степени**|Связанные узлы имеют схожую степень.|Коэффициент ассортативности графа ego-network.| Отрицательный (кроме ego 1912)|**Не подтверждено**. Наблюдается анти-ассортативность, хотя это и согласуется с концепцией ego-network|
  
**Выводы:**
1.	Пользовательские круги не являются структурными сообществами - силуэтный коэффициент близок к нулю и отрицателен.
2.	Семантическая связность узлов более устойчива, чем структурная - время жизни циклов в пространстве признаков выше, чем в структурном пространстве.
3.	Социальная реальность сложнее математических моделей - люди определяют круги по критериям географии, времени, эмоций, интересов, а не по структурным признакам.

#### Глобальная структура ####
**Топологические инварианты на полном графе:**  
•	Компоненты связности (H0): 1476 компоненты из 1500 узлов (98%) — граф становится связным при малых порогах расстояния Жаккара;  
•	Циклические структуры (H1): 712 циклов (47.5% от выборки) с характеристиками:  
      -	Среднее время жизни: 0.027;  
      -	Максимальное время жизни: 0.135.  
    
#### Сравнение результатов на локальном и глобальном уровнях: ####
|Геометрический Prior|Локальный уровень (ego-networks)|Глобальный уровень (полный граф)|Вывод|
|:-|--|--|--|
|Гомофилия|Опровергнута для пользовательских кругов (силуэтный коэффициент ≤ -0.02)|Невозможно проверить напрямую (нет ground truth кругов для всего графа)|Нет возможности сравнить результаты|
|Транзитивность|Частично подтверждена: циклы H₁ существуют, но нестабильны (короткое время жизни)|Подтверждена количественно: 534 цикла H₁ (44.5% выборки), но также нестабильны (mean lifetime=0.026)|Согласованость prior'а на обоих уровнях|
|Ассортативность по степени|Отрицательная (анти-ассортативность, звёздная структура)|Слабо положительная (+0.064)|Prior зависит от масштаба|  
  
**Итоговый вывод**: свойства социального графа демонстрируют выраженную масштабную зависимость. Prior'ы, наблюдаемые на локальном уровне, не экстраполируются на глобальную структуру сети.

## 4.	Обучение модели для решения предсказательной задачи ##

### 1. Установка эксперимента ###
Для baseline будут использованы PCA-эмбеддинги исходных анонимизированных признаков. Для обогащения датасета будут использованы топологические фичи, полученные из структурного TDA (семантические не использованы, так как на них и так построен baseline), глобальные параметры графа (global_pagerank, betweenness_centrality) и свойства, полученные из анализа ego-network, к которой принадлежит узел.  
10 ego-networks разделены 7-1-2 (train-validation-test).   
Будет использована геометрическая модель (Equivariant Neural Network):  
    - Архитектура: GAT (Graph Attention Network);  
    - Equivariance свойство: Инвариантность к перестановкам вершин;   
    - Параметры: 2 слоя GATConv, 4 головы внимания, размер скрытого представления (hidden_dim) 128, dropout - 0.3;  
    - Функция потерь: Binary Cross-Entropy.  

### 2.	Реализация ###
Представлена в ноутбуке 3. Eval GNN.ipynb  

### 3. Результаты ###
3.1 Количественные результаты
|Метрика| Baseline (PCA)|Enriched (PCA + TDA)|Улучшение%|
|:-|--|--|--|
|Micro F1|0.0883|0.1005|+13.8|       
|Macro F1|0.0311|0.0380|+22.2|     
|Precision|0.0556|0.0717|+29.0|     
|Recall|0.2313|0.2844|+23.0|
|Threshold|0.1|0.2|100|

3.2 Качественные наблюдения
1.	Precision-Recall: модель демонстрирует улучшение по обеим метрикам.
2.	Неоднородность улучшения по сетям:
    - Ego 1912: F1 улучшился с 0.0254 до 0.0297 (+17%);
    - Ego 3980: F1 улучшился с 0.0311 до 0.0377 (+21,2%).
3.	Низкие значения F1 (∼0.10) согласуются с результатом TDA (силуэтный коэффициент ≤ -0.02) и подтверждают особенность задачи: разметка пользователем кругов субъективна и слабо коррелируют со структурными или семантическими группами.

### 4. Выводы ###
1. Топологические признаки улучшают предсказательную способность GNN определять круги в ego-network (хотя TDA и показал, что они не являются структурными группами).
2. Персистентные диаграммы и топологические инварианты действительно кодируют информацию о структуре сообществ.
3. Глобальные признаки (pagerank, betweenness) оказались менее полезными, чем локальные структурные признаки (иначе бы улучшения для обоих тестах для обогащенной модели были бы одинаковы).
4. Низкие абсолютные значения F1 подтверждают вывод TDA-анализа о том, что пользовательские круги не соответствуют структурным кластерам


